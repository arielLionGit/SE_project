<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting System</title>
    <link rel="stylesheet" href="styles.css">
    <script src="colorblind.js"></script>
    <style>

        

    </style>
</head>
<body onload="startTime()">
    <div id="clock" aria-live="polite" aria-label="Current time"></div>
    <div class="container">
        <h1>Voting System</h1>
        
        <div class="color-blind-modes">
            <button onclick="toggleColorBlindList()" aria-haspopup="true" aria-expanded="false" id="colorBlindToggle">
                Color Blind Modes
            </button>
            <ul id="colorBlindList" style="display: none;">
                <li><button onclick="setColorBlindMode('normal')">Normal</button></li>
                <li><button onclick="setColorBlindMode('protanopia')">Protanopia</button></li>
                <li><button onclick="setColorBlindMode('deuteranopia')">Deuteranopia</button></li>
                <li><button onclick="setColorBlindMode('tritanopia')">Tritanopia</button></li>
                <li><button onclick="setColorBlindMode('tritanomaly')">Tritanomaly</button></li>
                <li><button onclick="setColorBlindMode('achromatopsia')">Achromatopsia</button></li>
            </ul>
        </div>

        <div class="color-blind-modes">
            <button onclick="toggleColorBlindList()" aria-haspopup="true" aria-expanded="false" id="colorBlindToggle">
                Color Blind Modes
            </button>
            <ul id="colorBlindList" style="display: none;">
                <li><button onclick="setColorBlindMode('normal')">Normal</button></li>
                <li><button onclick="setColorBlindMode('protanopia')">Protanopia</button></li>
                <li><button onclick="setColorBlindMode('deuteranopia')">Deuteranopia</button></li>
                <li><button onclick="setColorBlindMode('tritanopia')">Tritanopia</button></li>
                <li><button onclick="setColorBlindMode('tritanomaly')">Tritanomaly</button></li>
                <li><button onclick="setColorBlindMode('achromatopsia')">Achromatopsia</button></li>
            </ul>
        </div>
        
        <div id="loginForm">
            <h2>Hello</h2>
            <h3>Welcome Back</h3>
            <input type="text" id="username" placeholder="Username" aria-label="Enter your username">
            <input type="password" id="password" placeholder="Password" aria-label="Enter your password">
            <button onclick="login()" aria-label="Login to your account">Login</button>
            <a href="register.html" class="button" aria-label="Go to registration page">Register</a>
        </div>

        <div id="logoutSection" style="display: none;">
            <div class="user-icon-container">
                <img id="userIcon" src="" alt="User profile icon">
                <button onclick="changeUserIcon()" class="change-icon-button" aria-label="Change your profile icon">Change Icon</button>
            </div>
            <h2>Welcome, <span id="userDisplay"></span></h2>
            <p id="userType" aria-label="Your account type"></p>
            <button onclick="logout()" aria-label="Log out of your account">Logout</button>
            <div class="admin-buttons">
                <button onclick="location.href='create_poll.html'" class="button" aria-label="Create a new poll">Create New Poll</button>
                <button onclick="location.href='admin_manage_polls.html'" id="managePollsButton" class="button" style="display: none;" aria-label="Manage existing polls">Manage Polls</button>
                <button id="showUsersButton" class="button" style="display: none;" onclick="showUsersList()" aria-label="Show list of registered users">Show Users List</button>
            </div>
        </div>

        <div id="pollList" style="display: none;">
            <h2>Existing Polls</h2>
            <!-- Polls will be dynamically added here -->
        </div>
    </div>

    <div id="userListModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeUsersList()" aria-label="Close users list">&times;</span>
            <h2>Registered Users</h2>
            <div id="userListContent"></div>
        </div>
    </div>

    <script>
        function startTime() {
            const today = new Date();
            let h = today.getHours();
            let m = today.getMinutes();
            let s = today.getSeconds();
            m = checkTime(m);
            s = checkTime(s);
            document.getElementById('clock').innerHTML =  h + ":" + m + ":" + s;
            setTimeout(startTime, 1000);
        }

        function checkTime(i) {
            if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
            return i;
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Check for preset admin account
            if (username === 'admin' && password === 'admin') {
                localStorage.setItem('loggedInUser', 'admin');
                localStorage.setItem('isAdmin', 'true');
                showLoggedInState('admin', 'admin');
                return;
            }

            // Get users from localStorage
            const users = JSON.parse(localStorage.getItem('users')) || {};

            if (users[username] && users[username].password === password) {
                localStorage.setItem('loggedInUser', username);
                localStorage.setItem('isAdmin', users[username].type === 'admin' || users[username].type === 'limited_admin' ? 'true' : 'false');
                showLoggedInState(username, users[username].type);
            } else {
                alert('Invalid username or password');
            }
        }

        function logout() {
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('isAdmin');
            showLoggedOutState();
        }

        function showLoggedInState(username, userType) {
            console.log('Showing logged in state for:', username, 'Type:', userType);
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('logoutSection').style.display = 'block';
            document.getElementById('pollList').style.display = 'block';
            document.getElementById('userDisplay').textContent = username;
            document.getElementById('userType').textContent = `Account type: ${userType}`;
            
            const users = JSON.parse(localStorage.getItem('users')) || {};
            const userIcon = document.getElementById('userIcon');
            if (username === 'admin') {
                userIcon.src = users.admin && users.admin.icon ? users.admin.icon : 'admin-icon.png';
            } else if (users[username] && users[username].icon) {
                userIcon.src = users[username].icon;
            } else {
                userIcon.src = 'default-icon.png';
            }
            
            const managePollsButton = document.getElementById('managePollsButton');
            const showUsersButton = document.getElementById('showUsersButton');
            if (userType === 'admin' || userType === 'limited_admin') {
                managePollsButton.style.display = 'inline-block';
                showUsersButton.style.display = 'inline-block';
            } else {
                managePollsButton.style.display = 'none';
                showUsersButton.style.display = 'none';
            }
            
            fetchAndUpdatePolls();
            // Start auto-updating every 5 seconds
            setInterval(fetchAndUpdatePolls, 5000);
        }

        function showLoggedOutState() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('logoutSection').style.display = 'none';
            document.getElementById('pollList').style.display = 'none';
        }

        function fetchAndUpdatePolls() {
            let polls = JSON.parse(localStorage.getItem('polls')) || [];
            const currentTime = new Date().getTime();
            const isAdmin = localStorage.getItem('isAdmin') === 'true';

            if (!isAdmin) {
                polls = polls.filter(poll => {
                    const endTime = new Date(poll.endTime).getTime();
                    return endTime > currentTime;
                });
            }

            updatePollDisplay(polls, isAdmin);
        }

        function updatePollDisplay(polls, isAdmin) {
            const pollListDiv = document.getElementById('pollList');
            if (!pollListDiv) return;

            const loggedInUser = localStorage.getItem('loggedInUser');
            
            pollListDiv.innerHTML = '<h2>Existing Polls</h2>';
            
            polls.forEach(poll => {
                const pollDiv = document.createElement('div');
                pollDiv.id = `poll-${poll.id}`;
                pollDiv.className = 'poll';
                const currentTime = new Date().getTime();
                const endTime = new Date(poll.endTime).getTime();
                const isExpired = endTime <= currentTime;

                let optionsHtml = poll.options.map((option, index) => {
                    const isVoted = poll.votes && poll.votes[loggedInUser] === index;
                    const optionClass = isVoted ? 'poll-option voted' : 'poll-option';
                    return `
                        <div class="${optionClass}">
                            ${option.image ? `<img src="${option.image}" alt="Image for option: ${option.text}">` : ''}
                            <div class="poll-option-content">
                                <p>${truncateText(option.text, 40)}</p>
                                <p>Votes: <span id="votes-${poll.id}-${index}">${option.votes || 0}</span></p>
                            </div>
                            ${!isExpired ? `<button onclick="vote('${poll.id}', ${index})" aria-label="${isVoted ? 'You have voted for this option' : 'Vote for this option'}">${isVoted ? 'Voted' : 'Vote'}</button>` : ''}
                        </div>
                    `;
                }).join('');

                pollDiv.innerHTML = `
                    <h3>${truncateText(poll.name, 40)}</h3>
                    ${poll.description ? `<p class="poll-description">${poll.description}</p>` : ''}
                    <div class="poll-options" role="list" aria-label="Poll options">${optionsHtml}</div>
                    <p>Ends: ${new Date(poll.endTime).toLocaleString()}</p>
                    ${isExpired ? '<p class="expired-notice" aria-label="Poll has ended">This poll has ended</p>' : ''}
                    ${!isExpired ? `<button onclick="cancelVote('${poll.id}')" class="cancel-vote-button" aria-label="Cancel your vote for this poll">Cancel Vote</button>` : ''}
                `;

                pollListDiv.appendChild(pollDiv);
            });

            if (polls.length === 0) {
                pollListDiv.innerHTML += '<p>No active polls available.</p>';
            }
        }

        // Add this new function to truncate text
        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength - 3) + '...' : text;
        }

        function vote(pollId, optionIndex) {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (!loggedInUser) {
                alert('Please log in to vote.');
                return;
            }

            let polls = JSON.parse(localStorage.getItem('polls')) || [];
            const pollIndex = polls.findIndex(poll => poll.id === pollId);

            if (pollIndex !== -1) {
                if (!polls[pollIndex].votes) {
                    polls[pollIndex].votes = {};
                }

                const previousVote = polls[pollIndex].votes[loggedInUser];
                if (previousVote !== undefined) {
                    polls[pollIndex].options[previousVote].votes = Math.max(0, (polls[pollIndex].options[previousVote].votes || 0) - 1);
                }

                polls[pollIndex].votes[loggedInUser] = optionIndex;
                polls[pollIndex].options[optionIndex].votes = (polls[pollIndex].options[optionIndex].votes || 0) + 1;

                localStorage.setItem('polls', JSON.stringify(polls));
                
                alert(previousVote !== undefined ? 'Your vote has been changed.' : 'Your vote has been recorded.');
                fetchAndUpdatePolls(); // Update immediately after voting
            }
        }

        function showUsersList() {
            const users = JSON.parse(localStorage.getItem('users')) || {};
            const currentUser = localStorage.getItem('loggedInUser');
            const currentUserType = users[currentUser].type;
            let userListHTML = '<ul id="userList">';
            
            // Separate users into admins and regular users
            let adminUsers = [];
            let limitedAdminUsers = [];
            let regularUsers = [];
            
            for (let username in users) {
                if (username === 'admin' || users[username].type === 'admin') {
                    adminUsers.push(username);
                } else if (users[username].type === 'limited_admin') {
                    limitedAdminUsers.push(username);
                } else {
                    regularUsers.push(username);
                }
            }
            
            // Sort admin users alphabetically, but keep 'admin' at the top
            adminUsers.sort((a, b) => {
                if (a === 'admin') return -1;
                if (b === 'admin') return 1;
                return a.localeCompare(b);
            });
            
            // Add admin users
            adminUsers.forEach(username => {
                const adminType = username === 'admin' ? 'Root Admin' : 'Admin';
                userListHTML += `
                    <li>
                        <span class="user-info">${username} (${adminType})</span>
                        ${username !== 'admin' && currentUserType === 'admin' ? `
                            <button onclick="deleteUser('${username}')" class="delete-button" aria-label="Delete user ${username}">Delete</button>
                            <button onclick="unassignAdmin('${username}')" class="unassign-admin-button" aria-label="Remove admin rights from ${username}">Unassign Admin</button>
                        ` : ''}
                    </li>`;
            });
            
            // Add limited admin users
            limitedAdminUsers.forEach(username => {
                userListHTML += `
                    <li>
                        <span class="user-info">${username} (Limited Admin)</span>
                        ${currentUserType === 'admin' ? `
                            <button onclick="deleteUser('${username}')" class="delete-button" aria-label="Delete user ${username}">Delete</button>
                            <button onclick="unassignAdmin('${username}')" class="unassign-admin-button" aria-label="Remove admin rights from ${username}">Unassign Admin</button>
                        ` : ''}
                    </li>`;
            });
            
            // Add regular users
            regularUsers.sort((a, b) => a.localeCompare(b));
            regularUsers.forEach(username => {
                userListHTML += `
                    <li>
                        <span class="user-info">${username} (User)</span>
                        ${currentUserType === 'admin' ? `
                            <button onclick="deleteUser('${username}')" class="delete-button" aria-label="Delete user ${username}">Delete</button>
                            <button onclick="assignAdmin('${username}')" class="assign-admin-button" aria-label="Assign admin rights to ${username}">Assign Admin</button>
                            <button onclick="assignLimitedAdmin('${username}')" class="assign-limited-admin-button" aria-label="Assign limited admin rights to ${username}">Assign Limited Admin</button>
                        ` : ''}
                    </li>`;
            });
            
            userListHTML += '</ul>';
            
            document.getElementById('userListContent').innerHTML = userListHTML;
            document.getElementById('userListModal').style.display = 'block';
        }

        function closeUsersList() {
            document.getElementById('userListModal').style.display = 'none';
        }

        function deleteUser(username) {
            if (confirm(`Are you sure you want to delete user ${username}?`)) {
                let users = JSON.parse(localStorage.getItem('users')) || {};
                delete users[username];
                localStorage.setItem('users', JSON.stringify(users));
                
                // Remove user's votes from polls
                let polls = JSON.parse(localStorage.getItem('polls')) || [];
                polls.forEach(poll => {
                    if (poll.votes && poll.votes[username]) {
                        const votedOptionIndex = poll.votes[username];
                        poll.options[votedOptionIndex].votes--;
                        delete poll.votes[username];
                    }
                });
                localStorage.setItem('polls', JSON.stringify(polls));
                
                alert(`User ${username} has been deleted.`);
                showUsersList(); // Refresh the user list
            }
        }

        function assignAdmin(username) {
            if (confirm(`Are you sure you want to assign admin rights to ${username}?`)) {
                let users = JSON.parse(localStorage.getItem('users')) || {};
                if (users[username]) {
                    users[username].type = 'admin';
                    localStorage.setItem('users', JSON.stringify(users));
                    alert(`${username} has been assigned admin rights.`);
                    showUsersList(); // Refresh the user list
                } else {
                    alert(`User ${username} not found.`);
                }
            }
        }

        function unassignAdmin(username) {
            if (confirm(`Are you sure you want to remove admin rights from ${username}?`)) {
                let users = JSON.parse(localStorage.getItem('users')) || {};
                if (users[username]) {
                    users[username].type = 'user';
                    localStorage.setItem('users', JSON.stringify(users));
                    alert(`Admin rights have been removed from ${username}.`);
                    showUsersList(); // Refresh the user list
                } else {
                    alert(`User ${username} not found.`);
                }
            }
        }

        function registerUser(username, password, type = 'user') {
            let users = JSON.parse(localStorage.getItem('users')) || {};
            if (!users[username]) {
                users[username] = { 
                    password: password, 
                    type: type, 
                    icon: username === 'admin' ? 'admin-icon.png' : 'default-icon.png'
                };
                localStorage.setItem('users', JSON.stringify(users));
                console.log('User registered:', username, type);
            }
        }

        function updateUserTypes() {
            let users = JSON.parse(localStorage.getItem('users')) || {};
            let updated = false;

            for (let username in users) {
                if (users[username].type === 'normal') {
                    users[username].type = 'user';
                    updated = true;
                }
            }

            if (updated) {
                localStorage.setItem('users', JSON.stringify(users));
                console.log('User types updated from "normal" to "user"');
            } else {
                console.log('No user types needed updating');
            }
        }

        function changeUserIcon() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 100;
                        canvas.height = 100;
                        ctx.drawImage(img, 0, 0, 100, 100);
                        const resizedImage = canvas.toDataURL('image/jpeg');
                        
                        const loggedInUser = localStorage.getItem('loggedInUser');
                        let users = JSON.parse(localStorage.getItem('users')) || {};
                        if (!users[loggedInUser]) {
                            users[loggedInUser] = {};
                        }
                        users[loggedInUser].icon = resizedImage;
                        localStorage.setItem('users', JSON.stringify(users));
                        
                        document.getElementById('userIcon').src = resizedImage;
                        alert('User icon updated successfully!');
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            }
            input.click();
        }

        function assignLimitedAdmin(username) {
            if (confirm(`Are you sure you want to assign limited admin rights to ${username}?`)) {
                let users = JSON.parse(localStorage.getItem('users')) || {};
                if (users[username]) {
                    users[username].type = 'limited_admin';
                    localStorage.setItem('users', JSON.stringify(users));
                    alert(`${username} has been assigned limited admin rights.`);
                    showUsersList(); // Refresh the user list
                } else {
                    alert(`User ${username} not found.`);
                }
            }
        }

        window.onload = function() {
            console.log('Window loaded');
            updateUserTypes();
            
            // Ensure admin account exists with an icon
            let users = JSON.parse(localStorage.getItem('users')) || {};
            if (!users.admin) {
                registerUser('admin', 'admin', 'admin');
            } else if (!users.admin.icon) {
                users.admin.icon = 'admin-icon.png';
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            console.log('Users after initialization:', JSON.parse(localStorage.getItem('users')));
            console.log('Polls:', JSON.parse(localStorage.getItem('polls')));

            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                console.log('Logged in user:', loggedInUser);
                const userType = loggedInUser === 'admin' ? 'admin' : (users[loggedInUser] ? users[loggedInUser].type : 'user');
                showLoggedInState(loggedInUser, userType);
            } else {
                console.log('No user logged in');
                showLoggedOutState();
            }
            
            // Set color blind mode from localStorage if it exists
            const savedMode = localStorage.getItem('colorBlindMode');
            if (savedMode) {
                setColorBlindMode(savedMode);
            }
        }

        function displayPolls() {
            const polls = JSON.parse(localStorage.getItem('polls')) || [];
            const pollsContainer = document.getElementById('polls');
            pollsContainer.innerHTML = '<h2>Existing Polls</h2>';

            const currentUser = localStorage.getItem('loggedInUser');

            polls.forEach(poll => {
                const pollDiv = document.createElement('div');
                pollDiv.className = 'poll';
                
                let pollHtml = `
                    <h3>${poll.name}</h3>
                    <p>${poll.description || ''}</p>
                    <div class="options">
                `;

                poll.options.forEach(option => {
                    const hasVoted = option.votes && option.votes.includes(currentUser);
                    const optionClass = hasVoted ? 'option voted' : 'option';
                    pollHtml += `
                        <div class="${optionClass}">
                            <img src="${option.image}" alt="${option.text}">
                            <p>${option.text}</p>
                            <p>Votes: ${option.votes ? option.votes.length : 0}</p>
                            <button onclick="vote('${poll.id}', '${option.id}')" ${hasVoted ? 'disabled' : ''}>
                                ${hasVoted ? 'Voted' : 'Vote'}
                            </button>
                        </div>
                    `;
                });

                pollHtml += `
                    </div>
                    <p>Ends: ${new Date(poll.endTime).toLocaleString()}</p>
                    <button onclick="cancelVote('${poll.id}')" class="cancel-vote">Cancel Vote</button>
                `;

                pollDiv.innerHTML = pollHtml;
                pollsContainer.appendChild(pollDiv);
            });
        }

        function Poll({ poll }) {
            // ... existing code ...

            const handleCancelVote = () => {
                // Reset the user's selection
                setSelectedOption(null);
                // If you're tracking votes in state, you might need to update that here
                // If you're communicating with a backend, you might need to send a request here
            };

            // ... rest of the component ...
        }

        function cancelVote(pollId) {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (!loggedInUser) {
                alert('Please log in to cancel your vote.');
                return;
            }

            let polls = JSON.parse(localStorage.getItem('polls')) || [];
            const pollIndex = polls.findIndex(poll => poll.id === pollId);

            if (pollIndex !== -1) {
                if (polls[pollIndex].votes && polls[pollIndex].votes[loggedInUser] !== undefined) {
                    const previousVote = polls[pollIndex].votes[loggedInUser];
                    polls[pollIndex].options[previousVote].votes = Math.max(0, (polls[pollIndex].options[previousVote].votes || 0) - 1);
                    delete polls[pollIndex].votes[loggedInUser];

                    localStorage.setItem('polls', JSON.stringify(polls));
                    alert('Your vote has been cancelled.');
                    fetchAndUpdatePolls(); // Update immediately after cancelling
                } else {
                    alert('You haven\'t voted in this poll yet.');
                }
            }
        }

        function setColorBlindMode(mode) {
            document.body.className = 'color-blind-' + mode;
            localStorage.setItem('colorBlindMode', mode);
            toggleColorBlindList(); // Close the list after selection
        }

        function toggleColorBlindList() {
            const list = document.getElementById('colorBlindList');
            const toggle = document.getElementById('colorBlindToggle');
            if (list.style.display === 'none') {
                list.style.display = 'block';
                toggle.setAttribute('aria-expanded', 'true');
            } else {
                list.style.display = 'none';
                toggle.setAttribute('aria-expanded', 'false');
            }
        }
    </script>
</body>
</html>