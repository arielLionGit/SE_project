<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting System</title>
    <link rel="stylesheet" href="styles.css">
    <script src="colorblind.js"></script>
    <script src="security.js"></script>
    <style>

    </style>
</head>
<body>
    <h1>Voting System</h1>
    
    <div class="color-blind-modes">
        <button onclick="toggleColorBlindList()" aria-haspopup="true" aria-expanded="false" id="colorBlindToggle">
            Color Blind Modes
        </button>
        <div id="colorBlindList">
            <button onclick="setColorBlindMode('normal')">Normal</button>
            <button onclick="setColorBlindMode('protanopia')">Protanopia</button>
            <button onclick="setColorBlindMode('deuteranopia')">Deuteranopia</button>
            <button onclick="setColorBlindMode('tritanopia')">Tritanopia</button>
            <button onclick="setColorBlindMode('tritanomaly')">Tritanomaly</button>
            <button onclick="setColorBlindMode('achromatopsia')">Achromatopsia</button>
        </div>
    </div>

    <div id="loginForm">
        <h2>Hello</h2>
        <h3>Welcome Back</h3>
        <input type="text" id="username" placeholder="Username" aria-label="Enter your username">
        <input type="password" id="password" placeholder="Password" aria-label="Enter your password">
        <button onclick="login()" aria-label="Login to your account">Login</button>
        <a href="register.html" class="button" aria-label="Go to registration page">Register</a>
    </div>

    <div id="logoutSection" style="display: none;">
        <div class="user-icon-container">
            <img id="userIcon" src="" alt="User profile icon">
            <button onclick="changeUserIcon()" class="change-icon-button" aria-label="Change your profile icon">Change Icon</button>
        </div>
        <h2>Welcome, <span id="userDisplay"></span></h2>
        <p id="userType" aria-label="Your account type"></p>
        <button onclick="logout()" aria-label="Log out of your account">Logout</button>
        <div class="admin-buttons">
            <button onclick="location.href='create_poll.html'" class="button" aria-label="Create a new poll">Create New Poll</button>
            <button onclick="location.href='admin_manage_polls.html'" id="managePollsButton" class="button" style="display: none;" aria-label="Manage existing polls">Manage Polls</button>
            <button id="showUsersButton" class="button" style="display: none;" onclick="showUsersList()" aria-label="Show list of registered users">Show Users List</button>
        </div>
    </div>

    <div id="pollList" style="display: none;">
        <h2>Existing Polls</h2>
        <!-- Polls will be dynamically added here -->
    </div>

    <div id="userListModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeUsersList()" aria-label="Close users list">&times;</span>
            <h2>Registered Users</h2>
            <div id="userListContent"></div>
        </div>
    </div>

    <script>
        /**
         * Handles the user login process.
         * Checks credentials and sets up the logged-in state if successful.
         */
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Check for preset admin account
            if (username === 'admin' && password === 'admin') {
                localStorage.setItem('loggedInUser', 'admin');
                localStorage.setItem('isAdmin', 'true');
                showLoggedInState('admin', 'admin');
                return;
            }

            // Get users from localStorage
            const users = JSON.parse(localStorage.getItem('users')) || {};
            const encryptedUsername = encryptUsername(username);

            if (users[encryptedUsername] && users[encryptedUsername].password === encryptPassword(password)) {
                localStorage.setItem('loggedInUser', encryptedUsername);
                localStorage.setItem('isAdmin', users[encryptedUsername].type === 'admin' || users[encryptedUsername].type === 'limited_admin' ? 'true' : 'false');
                showLoggedInState(username, users[encryptedUsername].type);
            } else {
                alert('Invalid username or password');
            }
        }

        /**
         * Logs out the current user and resets the UI to the logged-out state.
         */
        function logout() {
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('isAdmin');
            showLoggedOutState();
        }

        /**
         * Updates the UI to reflect the logged-in state for a given user.
         * @param {string} username - The username of the logged-in user.
         * @param {string} userType - The type of the logged-in user (e.g., 'admin', 'user').
         */
        function showLoggedInState(username, userType) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('logoutSection').style.display = 'block';
            document.getElementById('pollList').style.display = 'block';
            document.getElementById('userDisplay').textContent = username;
            document.getElementById('userType').textContent = `Account type: ${userType}`;
            
            const users = JSON.parse(localStorage.getItem('users')) || {};
            const userIcon = document.getElementById('userIcon');
            const encryptedUsername = encryptUsername(username);
            if (username === 'admin') {
                userIcon.src = users.admin && users.admin.icon ? users.admin.icon : 'admin-icon.png';
            } else if (users[encryptedUsername] && users[encryptedUsername].icon) {
                userIcon.src = users[encryptedUsername].icon;
            } else {
                userIcon.src = 'default-icon.png';
            }
            
            const managePollsButton = document.getElementById('managePollsButton');
            const showUsersButton = document.getElementById('showUsersButton');
            if (userType === 'admin' || userType === 'limited_admin') {
                managePollsButton.style.display = 'inline-block';
                showUsersButton.style.display = 'inline-block';
            } else {
                managePollsButton.style.display = 'none';
                showUsersButton.style.display = 'none';
            }
            
            fetchAndUpdatePolls();
            setInterval(fetchAndUpdatePolls, 5000);
        }

        /**
         * Updates the UI to reflect the logged-out state.
         */
        function showLoggedOutState() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('logoutSection').style.display = 'none';
            document.getElementById('pollList').style.display = 'none';
        }

        /**
         * Fetches and updates the list of polls displayed to the user.
         */
        function fetchAndUpdatePolls() {
            let polls = JSON.parse(localStorage.getItem('polls')) || [];
            const currentTime = new Date().getTime();
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            updatePollDisplay(polls, isAdmin);
        }

        /**
         * Updates the display of polls based on the current data and user type.
         * @param {Array} polls - The array of poll objects to display.
         * @param {boolean} isAdmin - Whether the current user is an admin.
         */
        function updatePollDisplay(polls, isAdmin) {
            const pollListDiv = document.getElementById('pollList');
            if (!pollListDiv) return;

            const loggedInUser = localStorage.getItem('loggedInUser');
            
            pollListDiv.innerHTML = '<h2>Existing Polls</h2>';
            
            polls.forEach(poll => {
                const pollDiv = document.createElement('div');
                pollDiv.id = `poll-${poll.id}`;
                pollDiv.className = 'poll';
                const currentTime = new Date().getTime();
                const endTime = new Date(poll.endTime).getTime();
                const isExpired = endTime <= currentTime;

                let optionsHtml = poll.options.map((option, index) => {
                    const isVoted = poll.votes && poll.votes[loggedInUser] === index;
                    const optionClass = isVoted ? 'poll-option voted' : 'poll-option';
                    return `
                        <div class="${optionClass}">
                            ${option.image ? `<img src="${option.image}" alt="Image for option: ${option.text}">` : ''}
                            <div class="poll-option-content">
                                <p>${truncateText(option.text, 40)}</p>
                                <p>Votes: <span id="votes-${poll.id}-${index}">${option.votes || 0}</span></p>
                            </div>
                            ${!isExpired ? `<button onclick="vote('${poll.id}', ${index})" aria-label="${isVoted ? 'You have voted for this option' : 'Vote for this option'}">${isVoted ? 'Voted' : 'Vote'}</button>` : ''}
                        </div>
                    `;
                }).join('');


                let winnerAnnouncement = '';
                if (isExpired) {
                    const winner = getWinner(poll);
                    winnerAnnouncement = `<p class="winner-announcement" aria-label="Poll winner">The winner is ${winner.text}!!</p>`;
                }

                pollDiv.innerHTML = `
                    <h3>${truncateText(poll.name, 40)}</h3>
                    ${poll.description ? `<p class="poll-description">${poll.description}</p>` : ''}
                    <div class="poll-options" role="list" aria-label="Poll options">${optionsHtml}</div>
                    <p>Ends: ${new Date(poll.endTime).toLocaleString()}</p>
                    ${isExpired ? '<p class="expired-notice" aria-label="Poll has ended">This poll has ended</p>' : ''}
                    ${isExpired ? winnerAnnouncement : ''}
                    ${!isExpired ? `<button onclick="cancelVote('${poll.id}')" class="cancel-vote-button" aria-label="Cancel your vote for this poll">Cancel Vote</button>` : ''}
                `;

                pollListDiv.appendChild(pollDiv);
            });


            if (polls.length === 0) {
                pollListDiv.innerHTML += '<p>No polls available.</p>';
            }
        }

        /**
         * Determines the winning option for a given poll.
         * @param {Object} poll - The poll object to analyze.
         * @returns {Object} The winning option.
         */
        function getWinner(poll) {
            let maxVotes = 0;
            let winners = [];
            poll.options.forEach(option => {
                if (option.votes > maxVotes) {
                    maxVotes = option.votes;
                    winners = [option];
                } else if (option.votes === maxVotes) {
                    winners.push(option);
                }
            });
            return winners[Math.floor(Math.random() * winners.length)];
        }

        /**
         * Truncates text to a specified length, adding an ellipsis if necessary.
         * @param {string} text - The text to truncate.
         * @param {number} maxLength - The maximum length of the truncated text.
         * @returns {string} The truncated text.
         */
        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength - 3) + '...' : text;
        }

        /**
         * Records a user's vote for a specific option in a poll.
         * @param {string} pollId - The ID of the poll being voted on.
         * @param {number} optionIndex - The index of the option being voted for.
         */
        function vote(pollId, optionIndex) {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (!loggedInUser) {
                alert('Please log in to vote.');
                return;
            }

            let polls = JSON.parse(localStorage.getItem('polls')) || [];
            const pollIndex = polls.findIndex(poll => poll.id === pollId);

            if (pollIndex !== -1) {
                if (!polls[pollIndex].votes) {
                    polls[pollIndex].votes = {};
                }

                const previousVote = polls[pollIndex].votes[loggedInUser];
                if (previousVote !== undefined) {
                    polls[pollIndex].options[previousVote].votes = Math.max(0, (polls[pollIndex].options[previousVote].votes || 0) - 1);
                }

                polls[pollIndex].votes[loggedInUser] = optionIndex;
                polls[pollIndex].options[optionIndex].votes = (polls[pollIndex].options[optionIndex].votes || 0) + 1;

                localStorage.setItem('polls', JSON.stringify(polls));
                
                alert(previousVote !== undefined ? 'Your vote has been changed.' : 'Your vote has been recorded.');
                fetchAndUpdatePolls();
            }
        }

        /**
         * Displays a list of all registered users (admin function).
         */
        function showUsersList() {
            const users = JSON.parse(localStorage.getItem('users')) || {};
            const currentUser = localStorage.getItem('loggedInUser');
            const currentUserType = users[currentUser] ? users[currentUser].type : 'user';
            let userListHTML = '<ul id="userList">';
            
            let adminUsers = [];
            let limitedAdminUsers = [];
            let regularUsers = [];
            
            for (let encryptedUsername in users) {
                const decryptedUsername = decryptUsername(encryptedUsername);
                if (encryptedUsername === 'admin' || users[encryptedUsername].type === 'admin') {
                    adminUsers.push({encrypted: encryptedUsername, decrypted: decryptedUsername});
                } else if (users[encryptedUsername].type === 'limited_admin') {
                    limitedAdminUsers.push({encrypted: encryptedUsername, decrypted: decryptedUsername});
                } else {
                    regularUsers.push({encrypted: encryptedUsername, decrypted: decryptedUsername});
                }
            }
            
            adminUsers.sort((a, b) => {
                if (a.encrypted === 'admin') return -1;
                if (b.encrypted === 'admin') return 1;
                return a.decrypted.localeCompare(b.decrypted);
            });
            
            adminUsers.forEach(user => {
                const adminType = user.encrypted === 'admin' ? 'Root Admin' : 'Admin';
                userListHTML += `
                    <li>
                        <span class="user-info">${user.decrypted} (${adminType})</span>
                        ${user.encrypted !== 'admin' && currentUserType === 'admin' ? `
                            <button onclick="deleteUser('${user.encrypted}')" class="delete-button" aria-label="Delete user ${user.decrypted}">Delete</button>
                            <button onclick="unassignAdmin('${user.encrypted}')" class="unassign-admin-button" aria-label="Remove admin rights from ${user.decrypted}">Unassign Admin</button>
                        ` : ''}
                    </li>`;
            });
            
            limitedAdminUsers.forEach(user => {
                userListHTML += `
                    <li>
                        <span class="user-info">${user.decrypted} (Limited Admin)</span>
                        ${currentUserType === 'admin' ? `
                            <button onclick="deleteUser('${user.encrypted}')" class="delete-button" aria-label="Delete user ${user.decrypted}">Delete</button>
                            <button onclick="unassignAdmin('${user.encrypted}')" class="unassign-admin-button" aria-label="Remove admin rights from ${user.decrypted}">Unassign Admin</button>
                        ` : ''}
                    </li>`;
            });
            
            regularUsers.sort((a, b) => a.decrypted.localeCompare(b.decrypted));
            regularUsers.forEach(user => {
                userListHTML += `
                    <li>
                        <span class="user-info">${user.decrypted} (User)</span>
                        ${currentUserType === 'admin' ? `
                            <button onclick="deleteUser('${user.encrypted}')" class="delete-button" aria-label="Delete user ${user.decrypted}">Delete</button>
                            <button onclick="assignAdmin('${user.encrypted}')" class="assign-admin-button" aria-label="Assign admin rights to ${user.decrypted}">Assign Admin</button>
                            <button onclick="assignLimitedAdmin('${user.encrypted}')" class="assign-limited-admin-button" aria-label="Assign limited admin rights to ${user.decrypted}">Assign Limited Admin</button>
                        ` : ''}
                    </li>`;
            });
            
            userListHTML += '</ul>';
            
            document.getElementById('userListContent').innerHTML = userListHTML;
            document.getElementById('userListModal').style.display = 'block';
        }

        /**
         * Closes the modal displaying the list of users.
         */
        function closeUsersList() {
            document.getElementById('userListModal').style.display = 'none';
        }

        /**
         * Deletes a user from the system (admin function).
         * @param {string} encryptedUsername - The encrypted username of the user to delete.
         */
        function deleteUser(encryptedUsername) {
            const decryptedUsername = decryptUsername(encryptedUsername);
            if (confirm(`Are you sure you want to delete user ${decryptedUsername}?`)) {
                let users = JSON.parse(localStorage.getItem('users')) || {};
                delete users[encryptedUsername];
                localStorage.setItem('users', JSON.stringify(users));
                
                let polls = JSON.parse(localStorage.getItem('polls')) || [];
                polls.forEach(poll => {
                    if (poll.votes && poll.votes[encryptedUsername]) {
                        const votedOptionIndex = poll.votes[encryptedUsername];
                        poll.options[votedOptionIndex].votes--;
                        delete poll.votes[encryptedUsername];
                    }
                });
                localStorage.setItem('polls', JSON.stringify(polls));
                
                alert(`User ${decryptedUsername} has been deleted.`);
                showUsersList();
            }
        }

        /**
         * Assigns admin rights to a user (admin function).
         * @param {string} encryptedUsername - The encrypted username of the user to promote.
         */
        function assignAdmin(encryptedUsername) {
            const decryptedUsername = decryptUsername(encryptedUsername);
            if (confirm(`Are you sure you want to assign admin rights to ${decryptedUsername}?`)) {
                let users = JSON.parse(localStorage.getItem('users')) || {};
                if (users[encryptedUsername]) {
                    users[encryptedUsername].type = 'admin';
                    localStorage.setItem('users', JSON.stringify(users));
                    alert(`${decryptedUsername} has been assigned admin rights.`);
                    showUsersList();
                } else {
                    alert(`User ${decryptedUsername} not found.`);
                }
            }
        }

        /**
         * Removes admin rights from a user (admin function).
         * @param {string} encryptedUsername - The encrypted username of the admin to demote.
         */
        function unassignAdmin(encryptedUsername) {
            const decryptedUsername = decryptUsername(encryptedUsername);
            if (confirm(`Are you sure you want to remove admin rights from ${decryptedUsername}?`)) {
                let users = JSON.parse(localStorage.getItem('users')) || {};
                if (users[encryptedUsername]) {
                    users[encryptedUsername].type = 'user';
                    localStorage.setItem('users', JSON.stringify(users));
                    alert(`Admin rights have been removed from ${decryptedUsername}.`);
                    showUsersList();
                } else {
                    alert(`User ${decryptedUsername} not found.`);
                }
            }
        }

        /**
         * Assigns limited admin rights to a user (admin function).
         * @param {string} encryptedUsername - The encrypted username of the user to promote.
         */
        function assignLimitedAdmin(encryptedUsername) {
            const decryptedUsername = decryptUsername(encryptedUsername);
            if (confirm(`Are you sure you want to assign limited admin rights to ${decryptedUsername}?`)) {
                let users = JSON.parse(localStorage.getItem('users')) || {};
                if (users[encryptedUsername]) {
                    users[encryptedUsername].type = 'limited_admin';
                    localStorage.setItem('users', JSON.stringify(users));
                    alert(`${decryptedUsername} has been assigned limited admin rights.`);
                    showUsersList();
                } else {
                    alert(`User ${decryptedUsername} not found.`);
                }
            }
        }

        /**
         * Cancels a user's vote on a specific poll.
         * @param {string} pollId - The ID of the poll to cancel the vote for.
         */
        function cancelVote(pollId) {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (!loggedInUser) {
                alert('Please log in to cancel your vote.');
                return;
            }

            let polls = JSON.parse(localStorage.getItem('polls')) || [];
            const pollIndex = polls.findIndex(poll => poll.id === pollId);

            if (pollIndex !== -1) {
                if (polls[pollIndex].votes && polls[pollIndex].votes[loggedInUser] !== undefined) {
                    const previousVote = polls[pollIndex].votes[loggedInUser];
                    polls[pollIndex].options[previousVote].votes = Math.max(0, (polls[pollIndex].options[previousVote].votes || 0) - 1);
                    delete polls[pollIndex].votes[loggedInUser];

                    localStorage.setItem('polls', JSON.stringify(polls));
                    alert('Your vote has been cancelled.');
                    fetchAndUpdatePolls();
                } else {
                    alert('You haven\'t voted in this poll yet.');
                }
            }
        }

        /**
         * Sets the color blind mode for the application.
         * @param {string} mode - The color blind mode to set.
         */
        function setColorBlindMode(mode) {
            document.body.className = 'color-blind-' + mode;
            localStorage.setItem('colorBlindMode', mode);
            hideColorBlindList();
        }

        /**
         * Toggles the visibility of the color blind mode selection list.
         */
        function toggleColorBlindList() {
            const list = document.getElementById('colorBlindList');
            const toggle = document.getElementById('colorBlindToggle');
            if (list.style.display === 'none' || list.style.display === '') {
                list.style.display = 'block';
                toggle.setAttribute('aria-expanded', 'true');
            } else {
                hideColorBlindList();
            }
        }

        /**
         * Hides the color blind mode selection list.
         */
        function hideColorBlindList() {
            const list = document.getElementById('colorBlindList');
            const toggle = document.getElementById('colorBlindToggle');
            list.style.display = 'none';
            toggle.setAttribute('aria-expanded', 'false');
        }

        window.onclick = function(event) {
            if (!event.target.matches('#colorBlindToggle')) {
                hideColorBlindList();
            }
        }

        /**
         * Allows the user to change their profile icon.
         */
        function changeUserIcon() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 100;
                        canvas.height = 100;
                        ctx.drawImage(img, 0, 0, 100, 100);
                        const resizedImage = canvas.toDataURL('image/jpeg');
                        
                        const loggedInUser = localStorage.getItem('loggedInUser');
                        let users = JSON.parse(localStorage.getItem('users')) || {};
                        if (!users[loggedInUser]) {
                            users[loggedInUser] = {};
                        }
                        users[loggedInUser].icon = resizedImage;
                        localStorage.setItem('users', JSON.stringify(users));
                        
                        document.getElementById('userIcon').src = resizedImage;
                        alert('User icon updated successfully!');
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            }
            input.click();
        }

        /**
         * Encrypts a username (placeholder function).
         * @param {string} username - The username to encrypt.
         * @returns {string} The encrypted username.
         */
        function encryptUsername(username) {
            // This is a placeholder function. In a real-world scenario, you'd use proper encryption.
            return username; // For now, we're not actually encrypting
        }

        /**
         * Decrypts an encrypted username.
         * @param {string} encryptedUsername - The encrypted username to decrypt.
         * @returns {string} The decrypted username.
         */
        function decryptUsername(encryptedUsername) {
            const users = JSON.parse(localStorage.getItem('users')) || {};
            if (users[encryptedUsername] && users[encryptedUsername].originalUsername) {
                return users[encryptedUsername].originalUsername;
            }
            // Fallback to displaying part of the encrypted username if original is not found
            return encryptedUsername;
        }

        /**
         * Encrypts a password (placeholder function).
         * @param {string} password - The password to encrypt.
         * @returns {string} The encrypted password.
         */
        function encryptPassword(password) {
            // This is a placeholder function. In a real-world scenario, you'd use proper encryption.
            return password; // For now, we're not actually encrypting
        }

        window.onload = function() {
            const savedMode = localStorage.getItem('colorBlindMode');
            if (savedMode) {
                setColorBlindMode(savedMode);
            }

            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const users = JSON.parse(localStorage.getItem('users')) || {};
                const userType = loggedInUser === 'admin' ? 'admin' : (users[loggedInUser] ? users[loggedInUser].type : 'user');
                showLoggedInState(decryptUsername(loggedInUser), userType);
            } else {
                showLoggedOutState();
            }
        }


    </script>





<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB50tmJ19NYMkC9uxldDz1HcI72SbYo55w",
      authDomain: "se-fun.firebaseapp.com",
      projectId: "se-fun",
      storageBucket: "se-fun.appspot.com",
      messagingSenderId: "409521764544",
      appId: "1:409521764544:web:06c0e2da2f526821709525"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
  </script>





</body>
</html>