<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Manage Polls</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="colorblind.js"></script>
    <style>

    </style>
</head>
<body>
    <div class="container">
        <h1>Manage Polls</h1>
        <div class="top-buttons">
            <button onclick="location.href='index.html'" aria-label="Return to main page">Back to Main Page</button>
            <button id="deleteAllPollsButton" onclick="deleteAllPolls()" style="display: none;" aria-label="Delete all polls">Delete All Polls</button>
        </div>
        <div id="pollList" aria-live="polite"></div>

        <div id="userListModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Registered Users</h2>
                <div id="userListContent"></div>
            </div>
        </div>
    
        <!-- ... other HTML content ... -->
    
        <template id="userListItemTemplate">
            <li>
                <span class="username"></span>
                <span class="userType"></span>
                <button class="delete-button">Delete</button>
                <button class="assign-admin-button">Assign Admin</button>
                <button class="unassign-admin-button">Unassign Admin</button>
                <button class="assign-limited-admin-button">Assign Limited Admin</button>
                <button class="show-sensitive-info-button">Show Sensitive Info</button>
            </li>
        </template>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        /**
         * Loads and displays all polls for admin management.
         * This function retrieves polls from localStorage, calculates vote percentages, and renders the poll management UI.
         */
        function loadPolls() {
            const polls = JSON.parse(localStorage.getItem('polls')) || [];
            const pollList = document.getElementById('pollList');
            pollList.innerHTML = '';

            // Get the current user type
            const currentUser = localStorage.getItem('loggedInUser');
            const users = JSON.parse(localStorage.getItem('users')) || {};
            const currentUserType = users[currentUser] ? users[currentUser].type : 'user';

            polls.forEach(poll => {
                const pollDiv = document.createElement('div');
                pollDiv.className = 'poll-management';
                const currentTime = new Date().getTime();
                const endTime = new Date(poll.endTime).getTime();
                const isExpired = endTime <= currentTime;

                // Calculate total votes and percentages
                const totalVotes = poll.options.reduce((sum, option) => sum + (option.votes || 0), 0);
                const optionsWithPercentages = poll.options.map(option => ({
                    ...option,
                    percentage: totalVotes > 0 ? ((option.votes || 0) / totalVotes * 100).toFixed(1) : '0.0'
                }));

                pollDiv.innerHTML = `
                    <h3>${poll.name}</h3>
                    <p>${poll.description || 'No description'}</p>
                    <p>Ends: ${new Date(poll.endTime).toLocaleString()}</p>
                    ${isExpired ? '<p class="expired-notice">This poll has ended</p>' : ''}
                    <div class="poll-container">
                        <div class="poll-options-list" role="list" aria-label="Poll options and results">
                            ${optionsWithPercentages.map((option, index) => `
                                <div class="poll-option-item" style="background-color: ${getColor(index)}" role="listitem">
                                    <span class="option-text">${option.text}: ${option.percentage}%</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="poll-chart">
                            <canvas id="chart-${poll.id}" width="200" height="200" aria-label="Pie chart of poll results" role="img"></canvas>
                        </div>
                    </div>
                    <div class="poll-actions">
                        ${currentUserType === 'admin' ? `<button onclick="deletePoll('${poll.id}')" class="action-button" aria-label="Delete this poll">Delete Poll</button>` : ''}
                        <button onclick="downloadChart('${poll.id}')" class="action-button" aria-label="Download chart image">Download Chart</button>
                    </div>
                `;
                pollList.appendChild(pollDiv);
                updatePieChart(poll);
            });

            if (polls.length === 0) {
                pollList.innerHTML = '<p>No polls available.</p>';
            }

            // Show "Delete All Polls" button only for root admin
            const deleteAllPollsButton = document.getElementById('deleteAllPollsButton');
            if (currentUser === 'admin') {
                deleteAllPollsButton.style.display = 'block';
            } else {
                deleteAllPollsButton.style.display = 'none';
            }
        }

        /**
         * Creates and updates a pie chart for a given poll.
         * @param {Object} poll - The poll object containing options and vote data.
         */
        function updatePieChart(poll) {
            const ctx = document.getElementById(`chart-${poll.id}`).getContext('2d');
            
            // Include all options, even those with 0 votes
            const data = {
                labels: poll.options.map(option => option.text),
                datasets: [{
                    data: poll.options.map(option => option.votes || 0),
                    backgroundColor: poll.options.map((_, index) => getColor(index)),
                }]
            };
            
            new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false, // Hide the legend
                        },
                        title: {
                            display: false, // Hide the title
                        },
                        tooltip: {
                            enabled: false, // Disable tooltips
                        },
                        datalabels: {
                            display: false, // Hide data labels
                        }
                    },
                    elements: {
                        arc: {
                            borderWidth: 0,
                            minAngle: 0.5 // Set a minimum angle for very small slices
                        }
                    }
                }
            });
        }

        /**
         * Deletes a specific poll after confirming with the admin.
         * @param {string} pollId - The ID of the poll to be deleted.
         */
        function deletePoll(pollId) {
            // Check user type before allowing deletion
            const currentUser = localStorage.getItem('loggedInUser');
            const users = JSON.parse(localStorage.getItem('users')) || {};
            const currentUserType = users[currentUser] ? users[currentUser].type : 'user';

            if (currentUserType !== 'admin') {
                alert('You do not have permission to delete polls.');
                return;
            }

            if (confirm('Are you sure you want to delete this poll?')) {
                let polls = JSON.parse(localStorage.getItem('polls')) || [];
                polls = polls.filter(poll => poll.id !== pollId);
                localStorage.setItem('polls', JSON.stringify(polls));
                loadPolls();
            }
        }

        /**
         * Generates and initiates download of a chart image for a specific poll.
         * @param {string} pollId - The ID of the poll for which to download the chart.
         */
        function downloadChart(pollId) {
            const polls = JSON.parse(localStorage.getItem('polls')) || [];
            const poll = polls.find(p => p.id === pollId);
            
            if (!poll) {
                console.error('Poll not found');
                return;
            }

            const canvas = document.getElementById(`chart-${pollId}`);
            const chart = Chart.getChart(canvas);

            // Create a new canvas
            const downloadCanvas = document.createElement('canvas');
            const ctx = downloadCanvas.getContext('2d');
            downloadCanvas.width = 600;
            downloadCanvas.height = 400 + (poll.options.length * 20); // Adjust height based on number of options

            // Draw white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, downloadCanvas.width, downloadCanvas.height);

            // Draw the chart
            ctx.drawImage(canvas, 150, 50, 300, 300);

            // Draw the title
            ctx.font = 'bold 20px Arial';
            ctx.fillStyle = 'black';
            ctx.textAlign = 'center';
            ctx.fillText(`Poll: ${poll.name}`, downloadCanvas.width / 2, 30);

            // Draw the options and percentages
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            const totalVotes = poll.options.reduce((sum, option) => sum + (option.votes || 0), 0);
            poll.options.forEach((option, index) => {
                const percentage = totalVotes > 0 ? ((option.votes || 0) / totalVotes * 100).toFixed(1) : '0.0';
                const yPosition = 370 + index * 20;
                
                // Draw color box
                ctx.fillStyle = chart.data.datasets[0].backgroundColor[index % chart.data.datasets[0].backgroundColor.length];
                ctx.fillRect(20, yPosition - 10, 15, 15);
                
                // Draw text
                ctx.fillStyle = 'black';
                ctx.fillText(`${option.text}: ${percentage}%`, 40, yPosition);
            });

            // Add accessibility information to the downloaded image
            ctx.font = '12px Arial';
            ctx.fillStyle = 'black';
            ctx.textAlign = 'center';
            ctx.fillText('This image shows a pie chart of poll results.', downloadCanvas.width / 2, downloadCanvas.height - 20);

            // Convert the canvas to a data URL
            const image = downloadCanvas.toDataURL('image/png');

            // Create a temporary link element
            const link = document.createElement('a');
            link.href = image;
            link.download = `Poll_of_${poll.name.replace(/\s+/g, '_')}.png`;
            
            // Trigger the download
            link.click();
        }

        /**
         * Returns a color from a predefined array based on the given index.
         * @param {number} index - The index to use for color selection.
         * @returns {string} A color in rgba format.
         */
        function getColor(index) {
            const colors = [
                'rgba(255, 99, 132, 0.8)',   // Red
                'rgba(54, 162, 235, 0.8)',   // Blue
                'rgba(255, 206, 86, 0.8)',   // Yellow
                'rgba(75, 192, 192, 0.8)',   // Teal
                'rgba(153, 102, 255, 0.8)',  // Purple
                'rgba(255, 159, 64, 0.8)',   // Orange
                'rgba(0, 204, 150, 0.8)',    // Green
                'rgba(255, 99, 255, 0.8)',   // Pink
                'rgba(128, 128, 128, 0.8)',  // Gray
                'rgba(0, 128, 128, 0.8)',    // Dark Teal
                'rgba(128, 0, 128, 0.8)',    // Dark Purple
                'rgba(128, 128, 0, 0.8)',    // Olive
                'rgba(0, 0, 128, 0.8)',      // Navy
                'rgba(128, 0, 0, 0.8)',      // Maroon
                'rgba(210, 105, 30, 0.8)',   // Chocolate
            ];
            return colors[index % colors.length];
        }

        /**
         * Deletes all polls after confirming with the admin.
         * This function clears all polls from localStorage and refreshes the poll display.
         */
        function deleteAllPolls() {
            if (confirm('Are you sure you want to delete all polls? This action cannot be undone.')) {
                localStorage.setItem('polls', JSON.stringify([]));
                alert('All polls have been deleted.');
                loadPolls(); // Refresh the poll display
            }
        }

        window.onload = function() {
            const currentUser = localStorage.getItem('loggedInUser');
            const users = JSON.parse(localStorage.getItem('users')) || {};
            const currentUserType = users[currentUser] ? users[currentUser].type : 'user';

            if (currentUserType === 'admin' || currentUserType === 'limited_admin') {
                loadPolls();
            } else {
                alert('You do not have permission to access this page.');
                window.location.href = 'index.html'; // Redirect to main page
            }
        };
    </script>
</body>
</html>